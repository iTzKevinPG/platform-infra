name: Deploy Platform Compose

on:
  workflow_run:
    workflows:
      - Terraform Infrastructure
    types:
      - completed
  workflow_dispatch:

jobs:
  deploy:
    if: github.event_name == 'workflow_dispatch' || github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}

      - name: Copy compose file to droplet
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_SSH_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          source: runtime/docker-compose.yml
          target: /tmp

      - name: Reload docker compose stack
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_SSH_USER }}
          key: ${{ secrets.DO_SSH_KEY }}
          script: |
            set -euo pipefail
            sudo mkdir -p /opt/platform
            sudo mv /tmp/runtime/docker-compose.yml /opt/platform/docker-compose.yml
            sudo chown root:root /opt/platform/docker-compose.yml
            cat <<'EOF' | sudo tee /opt/platform/.env.platform >/dev/null
            TRAEFIK_ACME_EMAIL=${{ secrets.TRAEFIK_EMAIL }}
            CF_DNS_API_TOKEN=${{ secrets.CF_DNS_API_TOKEN }}
            PORTFOLIO_HOST=${{ vars.PORTFOLIO_HOST }}
            PORTFOLIO_IMAGE=${{ vars.PORTFOLIO_IMAGE }}
            PORTFOLIO_INTERNAL_PORT=${{ vars.PORTFOLIO_INTERNAL_PORT }}
            DOCKER_API_VERSION=${{ vars.DOCKER_API_VERSION }}
            EOF
            sudo chown root:root /opt/platform/.env.platform
            sudo chmod 600 /opt/platform/.env.platform
            if ! docker network inspect reverse-proxy >/dev/null 2>&1; then
              docker network create reverse-proxy
            fi
            cd /opt/platform
            docker compose --env-file .env.platform --project-name platform_portfolio pull
            docker compose --env-file .env.platform --project-name platform_portfolio up -d
